name: Build Balloon APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –°–∫–∞—á–∞—Ç—å –∫–æ–¥
    - uses: actions/checkout@v4
    
    # 2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—É (—É–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª)
    - name: Fix texture name
      run: |
        if [ -f "Normal 1.png" ]; then
          mv "Normal 1.png" Normal1.png
          echo "‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª: Normal 1.png ‚Üí Normal1.png"
        fi
        
    # 3. –°–∫–∞—á–∞—Ç—å Godot
    - name: Setup Godot
      run: |
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Godot 4.1.3..."
        wget -q https://github.com/godotengine/godot/releases/download/4.1.3-stable/Godot_v4.1.3-stable_linux.x86_64.zip
        unzip -q Godot_v4.1.3-stable_linux.x86_64.zip
        chmod +x Godot_v4.1.3-stable_linux.x86_64
        mv Godot_v4.1.3-stable_linux.x86_64 godot
        echo "‚úÖ Godot –≥–æ—Ç–æ–≤"
        
    # 4. –°–∫–∞—á–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è Android
    - name: Download Android templates
      run: |
        echo "üì• –°–∫–∞—á–∏–≤–∞—é Android —à–∞–±–ª–æ–Ω—ã..."
        wget -q https://github.com/godotengine/godot/releases/download/4.1.3-stable/Godot_v4.1.3-stable_export_templates.tpz
        mkdir -p ~/.local/share/godot/export_templates/4.1.3.stable/
        unzip -q Godot_v4.1.3-stable_export_templates.tpz -d ~/.local/share/godot/export_templates/4.1.3.stable/
        echo "‚úÖ –®–∞–±–ª–æ–Ω—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤: ~/.local/share/godot/export_templates/4.1.3.stable/"
        
    # 5. –°–æ–∑–¥–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
    - name: Create project files
      run: |
        echo "‚öôÔ∏è –°–æ–∑–¥–∞—é —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
        
        # project.godot - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ñ–∞–π–ª
        cat > project.godot << 'EOF'
[application]
config/name="Balloon Game"
config/description="Balloon game for Pico-4"
run/main_scene="res://node_2d.tscn"

[rendering]
renderer/rendering_method="gl_compatibility"

[display]
window/size/width=1920
window/size/height=1080
window/size/mode="fullscreen"
EOF
        
        # export_presets.cfg - –ö–û–†–†–ï–ö–¢–ù–´–ô –∏ –ø–æ–ª–Ω—ã–π
        cat > export_presets.cfg << 'EOF'
[preset.0]
name="Android"
platform="Android"
runnable=true
export_filter="all_resources"
include_filter="*"
exclude_filter=""
custom_template=""
embedded_android_sdk=true
architectures/arm64-v8a=true
architectures/armeabi-v7a=false

[preset.0.options]
application/package="com.pico.balloon"
application/version="1"
application/version_code="1"
application/xr_features/openxr=true
application/graphics/api=1
xr/openxr/enabled=true
xr/openxr/form_factor=1
EOF
        
        # icon.svg - –ø—Ä–æ—Å—Ç–∞—è –∏–∫–æ–Ω–∫–∞
        cat > icon.svg << 'EOF'
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
<circle cx="64" cy="64" r="60" fill="#ff6b6b"/>
<circle cx="48" cy="48" r="8" fill="#fff"/>
<circle cx="80" cy="48" r="8" fill="#fff"/>
<path d="M48 90 Q64 110 80 90" stroke="#fff" stroke-width="6" fill="none"/>
</svg>
EOF
        
        echo "‚úÖ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–Ω—ã"
        
    # 6. –°–æ–∑–¥–∞—Ç—å debug keystore (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Android)
    - name: Create debug keystore
      run: |
        echo "üîê –°–æ–∑–¥–∞—é debug keystore..."
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç–æ–π keystore (–ø—É—Å—Ç–æ–π —Ñ–∞–π–ª, Godot —Å–æ–∑–¥–∞—Å—Ç —Å–≤–æ–π)
        echo "android" > debug.keystore
        echo "‚úÖ Keystore —Å–æ–∑–¥–∞–Ω"
        
    # 7. –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –µ—Å—Ç—å
    - name: List files
      run: |
        echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–µ–∫—Ç–∞:"
        ls -la
        
    # 8. –°–æ–±—Ä–∞—Ç—å APK
    - name: Build APK
      run: |
        echo "üî® –°–æ–±–∏—Ä–∞—é APK..."
        
        # –≠–∫—Å–ø–æ—Ä—Ç —Å –æ—Ç–ª–∞–¥–∫–æ–π
        ./godot --headless --export-debug "Android" balloon.apk 2>&1 | tee build.log
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ -f "balloon.apk" ]; then
          echo "üéâ –£–°–ü–ï–•! APK —Å–æ–∑–¥–∞–Ω!"
          echo "üìä –†–∞–∑–º–µ—Ä: $(du -h balloon.apk | cut -f1)"
          echo "üìÅ –§–∞–π–ª—ã –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏:"
          ls -la *.apk
        else
          echo "‚ùå –û–®–ò–ë–ö–ê! APK –Ω–µ —Å–æ–∑–¥–∞–Ω"
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
          tail -30 build.log
          echo "üìã –ü–æ–ª–Ω—ã–π –ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ build.log"
          exit 1
        fi
        
    # 9. –ó–∞–≥—Ä—É–∑–∏—Ç—å APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: balloon-game-apk
        path: balloon.apk
        retention-days: 7
        
    # 10. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    - name: Success message
      if: success()
      run: |
        echo "========================================"
        echo "‚úÖ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
        echo "========================================"
        echo "üì• –°–∫–∞—á–∞–π APK:"
        echo "   1. –ù–∞–∂–º–∏ –Ω–∞ 'balloon-game-apk' –≤ Artifacts"
        echo "   2. –°–∫–∞—á–∞–π ZIP –∞—Ä—Ö–∏–≤"
        echo "   3. –†–∞—Å–ø–∞–∫—É–π ‚Üí –≤–Ω—É—Ç—Ä–∏ balloon.apk"
        echo ""
        echo "üì≤ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ Pico-4:"
        echo "   adb install balloon.apk"
        echo "========================================"
