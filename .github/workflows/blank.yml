name: Build Balloon APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Rename texture
      run: |
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        if [ -f "Normal 1.png" ]; then
          mv "Normal 1.png" Normal1.png
          echo "‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª Normal 1.png ‚Üí Normal1.png"
        fi
        
    - name: Setup Godot
      run: |
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Godot 4.1.3..."
        wget -q https://github.com/godotengine/godot/releases/download/4.1.3-stable/Godot_v4.1.3-stable_linux.x86_64.zip
        unzip -q Godot_v4.1.3-stable_linux.x86_64.zip
        chmod +x Godot_v4.1.3-stable_linux.x86_64
        echo "‚úÖ Godot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
    - name: Create project config
      run: |
        echo "‚öôÔ∏è –°–æ–∑–¥–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
        # project.godot
        echo '[application]' > project.godot
        echo 'config/name="Balloon Game"' >> project.godot
        echo 'run/main_scene="res://node_2d.tscn"' >> project.godot
        
        # export_presets.cfg
        echo '[preset.0]' > export_presets.cfg
        echo 'name="Android"' >> export_presets.cfg
        echo 'platform="Android"' >> export_presets.cfg
        echo 'runnable=true' >> export_presets.cfg
        echo 'export_filter="all_resources"' >> export_presets.cfg
        echo 'custom_template=""' >> export_presets.cfg
        echo 'embedded_android_sdk=true' >> export_presets.cfg
        echo 'architectures/arm64-v8a=true' >> export_presets.cfg
        echo '' >> export_presets.cfg
        echo '[preset.0.options]' >> export_presets.cfg
        echo 'application/package="com.pico.balloon"' >> export_presets.cfg
        echo 'application/version="1"' >> export_presets.cfg
        echo 'application/version_code="1"' >> export_presets.cfg
        echo '‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞'
        
    - name: Build APK
      run: |
        echo "üî® –°–æ–±–∏—Ä–∞—é APK..."
        ./Godot_v4.1.3-stable_linux.x86_64 --headless --export-debug "Android" balloon.apk 2>&1 | tee build.log
        
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏:"
        if [ -f "balloon.apk" ]; then
          echo "‚úÖ APK —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –†–∞–∑–º–µ—Ä: $(du -h balloon.apk | cut -f1)"
        else
          echo "‚ùå APK –Ω–µ —Å–æ–∑–¥–∞–Ω! –õ–æ–≥–∏:"
          tail -50 build.log
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: balloon-apk
        path: balloon.apk
        retention-days: 7
        
    - name: Show success message
      if: success()
      run: |
        echo "üéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
        echo "üì• –°–∫–∞—á–∞–π APK –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ Artifacts ‚Üí balloon-ap–∫"
        echo "üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏ –Ω–∞ Pico-4: adb install balloon.apk"
